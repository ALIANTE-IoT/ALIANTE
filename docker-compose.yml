x-drone-env: &drone_env
    VEHICLE: "copter"
    HOME_LAT: "44.494000"
    HOME_LON: "11.342000"
    HOME_ALT: "10"
    HOME_HDG: "0"
    SIM_SPEEDUP: "1"
    WOT_PORT: "8080"
    WIPE_EEPROM: "1"

x-drone-svc: &drone_svc
    build: ./drone
    restart: unless-stopped
    networks: [drones]

services:
    # Drone 1: SITL+MAVProxy
    drone1:
        <<: *drone_svc
        environment:
            <<: *drone_env
            GCS_TCP_PORT: "5770"
            SYSID: "1"
            HOME_LAT: "44.494000"
            HOME_LON: "11.342000"
            SERVIENT_HOST: "127.0.0.1"
            SERVIENT_UDP_PORT: "14550"
            M2R_HOST: "127.0.0.1"
            M2R_PORT: "14551"
        ports:
            - "127.0.0.1:5770:5770"
            - "127.0.0.1:18088:8088"
            - "127.0.0.1:14551:14551"

    # mavlink2rest for drone1
    mav2rest1:
        image: patrickelectric/mavlink2rest:latest
        depends_on: [drone1]
        network_mode: "service:drone1"
        environment:
            MAVLINK_SRC: "udpin:127.0.0.1:14551"
            SERVER_PORT: "0.0.0.0:8088"

    # Node WoT Servient for drone1
    servient1:
        image: node:20-alpine
        working_dir: /app
        command: sh -lc "npm install && npm ci && node index.js"
        restart: unless-stopped
        networks: [drones]
        depends_on:
            mav2rest1: { condition: service_started }
            drone1: { condition: service_started }
            zion: { condition: service_started }
        environment:
            DRONE_NAME: "drone1"
            SYSID: "1"
            WOT_PORT: "8080"
            M2R_BASE: "http://drone1:8088"
            TDD_URL: "http://zion:3000"
            ZION_EMAIL: "drone1@mail.com"
            ZION_PASSWORD: "drone1password"
            ZION_JWT_SECRET: "prismlab"
            ZION_JWT_EXPIRES_IN: "7d"
        volumes:
            - ./servients/drone-node:/app
        ports:
            - "127.0.0.1:19080:8080"

    image-storage:
        build: ./image-storage-service
        restart: unless-stopped
        environment:
            PORT: "4100"
            STORAGE_DIR: "/data/uploads"
            PUBLIC_BASE_URL: "${IMAGE_PUBLIC_BASE_URL:-http://127.0.0.1:4100}"
        volumes:
            - image_uploads:/data/uploads
        ports:
            - "0.0.0.0:4100:4100"
        networks:
            - drones

    tree-analyzer:
        build: ./tree-analyzer-service
        restart: unless-stopped
        depends_on:
            image-storage: { condition: service_started }
            clustering: { condition: service_started }
        environment:
            PORT: "4000"
            OPENAI_API_KEY: "${OPENAI_API_KEY}"
            OPENAI_MODEL: "${OPENAI_MODEL:-gpt-4o-mini}"
        ports:
            - "127.0.0.1:4000:4000"
        networks:
            - drones

    clustering:
        build: ./postprocessing
        restart: unless-stopped
        environment:
            OPENAI_API_KEY: "${OPENAI_API_KEY}"
        volumes:
            - ./reports:/app
        ports:
            - "127.0.0.1:5051:5051"
        networks:
            - drones

    tree-analyzer-web:
        build: ./tree-analyzer-web
        restart: unless-stopped
        depends_on:
            tree-analyzer: { condition: service_started }
        ports:
            - "127.0.0.1:3000:80"
        networks:
            - drones

    database:
        image: postgres:14.3-alpine
        restart: unless-stopped
        environment:
            POSTGRES_USER: zion
            POSTGRES_PASSWORD: zion
            POSTGRES_DB: zion
        volumes:
            - zion_pg:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U zion -d zion"]
            interval: 5s
            timeout: 3s
            retries: 20
        networks: [drones]

    zion:
        image: vaimee/zion:latest
        depends_on:
            database:
                condition: service_healthy
        entrypoint:
            ["sh", "-c", "npm run db:migrate:latest && npm run start:prod"]
        ports:
            - "127.0.0.1:28081:3000"
        environment:
            ZION_NODE_ENV: production
            ZION_SERVER_PORT: 3000
            ZION_DB_HOST: database
            ZION_DB_PORT: 5432
            ZION_DB_USER: zion
            ZION_DB_PASSWORD: zion
            ZION_DB_DATABASE: zion
            ZION_JWT_SECRET: prismlab
            ZION_JWT_EXPIRES_IN: 7d
        networks: [drones]

networks:
    drones:
        driver: bridge
volumes:
    zion_pg:
    image_uploads:
